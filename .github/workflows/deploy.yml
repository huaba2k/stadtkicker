name: Build und Deploy (Neues Projekt)

on:
  push:
    # !!! PRÜFEN: Heißt dein Branch im neuen Repo 'master' oder 'main'?
    # GitHub Standard ist heute meist 'main'. Ich habe beide erlaubt:
    branches: [ master, main ]
  repository_dispatch:
    types: [sanity-update]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    # 1. Node Setup
    - name: Setup Node.js with Cache
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # 2. Build
    - name: Install Dependencies and Build
      run: |
        npm ci
        npm run build
      # !!! PRÜFEN: Erstellt dein Build-Script im neuen Projekt wirklich
      # einen Ordner namens "dist"? (Bei Nuxt oft ".output/public", bei Next "out")

    # 3. Deployment via LFTP
    - name: Deploy via LFTP
      env:
        # !!! WICHTIG: Hast du diese Secrets auch im NEUEN Repo unter
        # Settings -> Secrets and variables -> Actions angelegt?
        FTP_USER: ${{ secrets.FTP_USERNAME }}
        FTP_PASS: ${{ secrets.FTP_PASSWORD }}
        FTP_HOST: ${{ secrets.FTP_SERVER }}
      run: |
        sudo apt-get update
        sudo apt-get install -y lftp

        # Skript erstellen
        echo "set ftp:ssl-allow no;" > upload_script.txt
        echo "open -u \"$FTP_USER\",\"$FTP_PASS\" $FTP_HOST;" >> upload_script.txt
        
        # !!! WICHTIGSTE ÄNDERUNG HIER UNTEN:
        # 1. Pfad ./out/ -> Muss zum lokalen Build-Ordner passen.
        # 2. Pfad /web/DEIN-NEUER-ORDNER/ -> Muss auf dem Server existieren!
        
        echo "mirror -R -v --delete --parallel=1 ./out/ /web/" >> upload_script.txt
        
        # Debugging aktivieren, falls es immer noch fehlschlägt (optional)
        # echo "debug 3;" >> upload_script.txt

        lftp -f upload_script.txt